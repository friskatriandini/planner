<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Weekly Study ‚Äî All Features (Pastel Cute)</title>
<style>
  :root{
    --bg:#fff6fb; --card:#fff; --muted:#6b6b6b;
    --maroon:#8b2d39; --maroon-2:#b73d53; --pink:#ffd2e0; --accent:#ff6f91;
    --glass: rgba(255,255,255,0.6); --text:#211; --radius:12px; --shadow:0 8px 28px rgba(139,45,57,0.08);
  }
  [data-theme="dark"]{
    --bg:#141218; --card:#1c161b; --muted:#cfc3c8; --maroon:#ff9fb2; --maroon-2:#ff6f91; --text:#fff; --glass: rgba(255,255,255,0.03); --shadow: 0 8px 28px rgba(0,0,0,0.6);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;background:
    radial-gradient(1200px 600px at -10% 10%, rgba(255,175,200,0.06), transparent 6%),
    radial-gradient(800px 400px at 110% 90%, rgba(200,150,200,0.03), transparent 8%),
    var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
  /* header */
  header.appbar{position:sticky;top:0;z-index:60;display:flex;align-items:center;justify-content:space-between;padding:12px 18px;background:linear-gradient(90deg, rgba(255,255,255,0.6), rgba(255,255,255,0.2));backdrop-filter:blur(6px);border-bottom:1px solid rgba(0,0,0,0.04)}
  [data-theme="dark"] header.appbar{background:linear-gradient(90deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));border-bottom-color:rgba(255,255,255,0.03)}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(90deg,var(--pink),var(--accent));display:grid;place-items:center;color:white;font-weight:700}
  .brand h1{margin:0;font-size:16px}
  .brand p{margin:0;font-size:12px;color:var(--muted)}
  .controls{display:flex;gap:8px;align-items:center}
  .btn{padding:8px 12px;border-radius:10px;border:none;cursor:pointer}
  .btn.primary{background:var(--maroon-2);color:white}
  .btn.ghost{background:transparent;border:1px solid rgba(0,0,0,0.06);color:var(--text)}
  .chip{padding:6px 10px;border-radius:999px;background:linear-gradient(90deg,var(--pink),#fff);font-weight:700;color:var(--maroon-2)}
  /* layout */
  .layout{max-width:1150px;margin:18px auto;padding:12px;display:grid;grid-template-columns:280px 1fr;gap:18px}
  aside.sidebar{position:sticky;top:74px;padding:14px;border-radius:12px;background:var(--card);box-shadow:var(--shadow);border:1px solid rgba(255,255,255,0.02)}
  nav.menu{display:flex;flex-direction:column;gap:8px}
  nav.menu a{display:flex;gap:10px;align-items:center;padding:8px;border-radius:8px;color:var(--text);text-decoration:none}
  nav.menu a:hover{background:linear-gradient(90deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));transform:translateX(6px)}
  .main{min-height:60vh}
  .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:var(--shadow);border:1px solid rgba(255,255,255,0.02)}
  .week-header{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .pill{background:linear-gradient(90deg,var(--pink),#fff);padding:6px 10px;border-radius:999px;color:var(--maroon);font-weight:700}
  .days{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-top:12px}
  .day{display:flex;gap:12px;border-radius:12px;padding:12px;background:linear-gradient(180deg, rgba(255,240,246,0.6), rgba(255,255,255,0.6));align-items:flex-start;border:1px solid rgba(200,140,160,0.06)}
  .icon{width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,var(--pink),var(--accent));display:grid;place-items:center;color:white;font-weight:700}
  .day-title{font-weight:800;color:var(--maroon)}
  .task-list{width:100%}
  .task{display:flex;gap:10px;align-items:flex-start;padding:8px 0;border-bottom:1px dashed rgba(200,140,160,0.06)}
  .task:last-child{border-bottom:none}
  .task input[type=checkbox]{width:18px;height:18px;margin-top:4px;cursor:pointer}
  .task .title{font-weight:700}
  .task .meta{font-size:12px;color:var(--muted)}
  /* progress bar */
  .progress-wrap{margin-top:8px}
  .progress{height:10px;background:linear-gradient(90deg,rgba(0,0,0,0.03),rgba(0,0,0,0.01));border-radius:999px;overflow:hidden;border:1px solid rgba(0,0,0,0.03)}
  .progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--maroon-2),var(--accent));width:0%;transition:width 360ms ease}
  .progress-text{font-size:12px;color:var(--muted);margin-top:6px}
  /* pdf */
  .pdf-zone{margin-top:10px;padding:10px;border-radius:10px;background:linear-gradient(90deg, rgba(255,230,240,0.6), rgba(255,255,255,0.5));border:1px dashed rgba(200,140,160,0.06)}
  .pdf-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .pdf-btn{background:var(--maroon-2);color:white;border:none;padding:8px 12px;border-radius:10px;cursor:pointer}
  .pdf-btn.ghost{background:transparent;border:1px solid var(--maroon-2);color:var(--maroon-2)}
  .pdf-list{margin-top:8px;display:flex;flex-direction:column;gap:8px}
  .pdf-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;background:linear-gradient(180deg,#fff,#fff);border:1px solid rgba(200,140,160,0.06)}
  .pdf-item .name{font-weight:700}
  /* modal */
  .modal{position:fixed;left:0;top:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.5);z-index:140}
  .modal.open{display:flex}
  .modal .box{width:90%;max-width:900px;background:var(--card);padding:12px;border-radius:12px}
  .modal .box iframe{width:100%;height:70vh;border:none;border-radius:8px}
  /* stats */
  .stats{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .stat-card{padding:10px;border-radius:10px;background:linear-gradient(90deg,rgba(255,255,255,0.6),rgba(255,255,255,0.2));box-shadow:var(--shadow)}
  /* pomodoro */
  .timer{display:flex;gap:8px;align-items:center}
  .timer .display{font-size:28px;font-weight:800}
  /* focus mode */
  .focus-mode header.appbar, .focus-mode aside.sidebar{display:none}
  @media(max-width:980px){
    .layout{grid-template-columns:1fr;padding:10px}
    aside.sidebar{position:fixed;left:-320px;top:72px;width:280px;height:calc(100vh - 100px);overflow:auto;transition:left 220ms ease;z-index:90}
    aside.sidebar.open{left:16px}
    .hamburger{display:inline-flex}
    .days{grid-template-columns:1fr}
  }
  /* animations */
  .fade-in{animation:fadeInUp .6s ease both}
  @keyframes fadeInUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

/* =====================================================
   üì± MOBILE OPTIMIZATION ‚Äî FULL FIX
   =====================================================*/
@media (max-width: 768px){

  body{
    padding:0;
    overflow-x:hidden;
  }

  header.appbar{
    padding:10px 14px;
    flex-wrap:wrap;
    gap:10px;
  }

  .brand h1{
    font-size:14px;
  }
  .brand p{
    font-size:10px;
  }
  .logo{
    width:36px;
    height:36px;
    font-size:16px;
  }

  /* Controls tombol */
  .controls{
    width:100%;
    justify-content:flex-start;
    flex-wrap:wrap;
    gap:6px;
  }

  .controls .btn{
    padding:6px 10px;
    font-size:12px;
  }

  /* Layout utama */
  .layout{
    grid-template-columns:1fr;
    padding:8px;
    gap:12px;
  }

  /* Sidebar slide */
  aside.sidebar{
    position:fixed;
    top:72px;
    left:-320px;
    width:260px;
    height:calc(100vh - 80px);
    z-index:90;
    transition:left 0.25s ease;
    padding:14px;
  }
  aside.sidebar.open{
    left:12px;
  }

  /* Hamburger muncul */
  .hamburger{
    display:inline-flex !important;
    padding:6px 10px;
    background:var(--maroon-2);
    border:none;
    border-radius:8px;
    color:white;
    font-size:18px;
  }

  /* Card */
  .card{
    padding:12px;
    border-radius:10px;
  }

  /* Days grid ‚Üí 1 kolom */
  .days{
    grid-template-columns:1fr !important;
    gap:10px;
  }

  /* Day item */
  .day{
    flex-direction:column;
    padding:12px;
  }
  .icon{
    width:46px;
    height:46px;
    font-size:18px;
  }
  .day-title{
    font-size:16px;
  }

  /* Task */
  .task{
    align-items:flex-start;
  }
  .task input[type=checkbox]{
    margin-top:5px;
    width:16px;
    height:16px;
  }
  .task .title{
    font-size:14px;
  }

  /* Progress bar */
  .progress-text{
    font-size:11px;
  }

  /* Reflection section */
  #reflectionCard textarea{
    font-size:14px;
    padding:8px;
  }

  /* PDF modal */
  .modal .box{
    width:94%;
    padding:10px;
  }
  .modal .box iframe{
    height:60vh;
  }

  /* Buttons general */
  .btn{
    font-size:12px;
    padding:8px 10px;
  }
}

/* EXTRA: Very small phones */
@media (max-width: 480px){
  .brand h1 { font-size:12px; }
  .brand p { font-size:9px; }
  .controls .btn{ font-size:11px; padding:6px 8px; }
}

</style>
</head>
<body data-theme="light">

<header class="appbar">
  <div class="brand">
    <button class="icon-btn hamburger" id="hamburger" aria-label="menu">‚ò∞</button>
    <div class="logo">üìö</div>
    <div>
      <h1>Weekly BUMN Study</h1>
      <p class="small">Cute pastel ‚Ä¢ checklist ‚Ä¢ PDF ‚Ä¢ productivity</p>
    </div>
  </div>

  <div class="controls">
    <button class="btn ghost" id="exportBtn">Export JSON</button>
    <button class="btn ghost" id="exportCSV">Export CSV</button>
    <button class="btn ghost" id="importBtn">Import</button>
    <input type="file" id="importFile" accept="application/json" style="display:none">
    <button class="btn ghost" id="printBtn">Print</button>
    <button class="btn primary" id="themeToggle">üåô Dark</button>
  </div>
</header>

<div class="layout">

  <aside class="sidebar" id="sidebar">
    <div style="display:flex;gap:10px;align-items:center;margin-bottom:12px">
      <div style="width:44px;height:44px;border-radius:10px;background:linear-gradient(90deg,var(--pink),var(--accent));display:grid;place-items:center;color:white">‚ú®</div>
      <div><div style="font-weight:800">My Study</div><div style="font-size:12px;color:var(--muted)">Weekly planner</div></div>
    </div>

    <nav class="menu">
      <a href="#home">üè† Home</a>
      <a href="#schedule">üóì Jadwal</a>
      <a href="#reflection">üìù Reflection</a>
      <a href="#settings">‚öôÔ∏è Settings</a>
    </nav>

    <div style="margin-top:12px">
      <div style="font-weight:700;color:var(--maroon)">Quick Actions</div>
      <button class="btn primary" id="clearChecks" style="width:100%;margin-top:8px">Clear Checklist</button>
      <button class="btn ghost" id="resetAll" style="width:100%;margin-top:8px">Reset Semua</button>
      <div style="margin-top:12px">
        <div style="font-weight:700;color:var(--maroon)">Pomodoro</div>
        <div style="margin-top:8px" id="pomodoroControls"></div>
      </div>
      <div style="margin-top:12px">
        <div style="font-weight:700;color:var(--maroon)">Reminder</div>
        <input type="time" id="reminderTime" style="width:100%;margin-top:8px;padding:8px;border-radius:8px;border:1px solid #eee">
        <button class="btn ghost" id="setReminder" style="width:100%;margin-top:8px">Set Reminder</button>
      </div>
    </div>
  </aside>

  <main class="main">
    <section class="card fade-in">
      <div class="week-header">
        <div style="display:flex;gap:12px;align-items:center">
          <div class="pill">Weekly</div>
          <div>
            <div style="font-size:12px;color:var(--muted)">Target Score</div>
            <input id="targetScore" type="text" placeholder="Contoh: 80" style="padding:8px;border-radius:8px;border:1px solid rgba(200,140,160,0.06)">
          </div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <div class="stats" id="smallStats"></div>
        </div>
      </div>

      <div class="days" id="daysContainer"></div>
    </section>

    <section class="card fade-in" id="reflectionCard" style="margin-top:14px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:800">Weekly Reflection</div>
        <div style="font-size:12px;color:var(--muted)">Catatan singkat</div>
      </div>
      <div style="margin-top:12px;display:grid;gap:10px">
        <textarea id="rGood" rows="2" placeholder="Apa yang berjalan baik?"></textarea>
        <textarea id="rBad" rows="2" placeholder="Apa yang perlu diperbaiki?"></textarea>
        <textarea id="rPlan" rows="2" placeholder="Rencana minggu depan"></textarea>
      </div>
      <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
        <button class="btn primary" id="exportStats">Export Stats</button>
        <button class="btn ghost" id="openSummary">AI Summary</button>
        <button class="btn ghost" id="focusModeBtn">Focus Mode</button>
      </div>
      <div style="margin-top:12px">
        <canvas id="statChart" width="600" height="140" style="max-width:100%"></canvas>
      </div>
    </section>
  </main>
</div>

<footer style="text-align:center;padding:18px;color:var(--muted)">Made with ‚ú® ‚Äî repeat weekly to track progress</footer>

<!-- Modal for PDF viewer & AI summary -->
<div id="modal" class="modal" aria-hidden="true">
  <div class="box">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <div style="font-weight:800" id="modalTitle">PDF Viewer</div>
      <div style="display:flex;gap:8px">
        <button class="btn ghost" id="modalClose">Close</button>
      </div>
    </div>
    <iframe id="pdfFrame" src=""></iframe>
  </div>
</div>

<!-- AI Summary modal -->
<div id="summaryModal" class="modal" aria-hidden="true">
  <div class="box">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:800">AI Summary (Offline Helper)</div>
      <button class="btn ghost" id="summaryClose">Close</button>
    </div>
    <div style="margin-top:10px;display:grid;gap:8px">
      <textarea id="summaryInput" rows="6" placeholder="Paste text here (or leave empty to auto-scan filenames & tasks)"></textarea>
      <div style="display:flex;gap:8px">
        <button class="btn primary" id="genSummary">Generate Summary</button>
        <button class="btn ghost" id="copySummary">Copy</button>
      </div>
      <div style="margin-top:8px">
        <div style="font-weight:700">Summary</div>
        <div id="summaryResult" style="white-space:pre-wrap;padding:8px;border-radius:8px;background:linear-gradient(90deg,rgba(255,255,255,0.6),rgba(255,255,255,0.2));min-height:60px"></div>
      </div>
    </div>
  </div>
</div>

<script>
/* ------------------------
  Data model & storage
-------------------------*/
const TEMPLATE = [
  { day:'Senin', tasks:['Sinonim, Antonim, Analogi','Reading comprehension','25‚Äì40 soal + catat 5 kata baru'] },
  { day:'Selasa', tasks:['Aritmatika dasar','Deret angka & rasio','25‚Äì30 soal + hafal 5 rumus cepat'] },
  { day:'Rabu', tasks:['Pola gambar & rotasi','Deret visual','20‚Äì30 soal + tandai pola sulit'] },
  { day:'Kamis', tasks:['Pancasila, UUD 1945, NKRI','Wawasan kebangsaan','Ringkas 1‚Äì2 bab + 20 soal'] },
  { day:'Jumat', tasks:['Silogisme & Asumsi','Penalaran analitis','25 soal + analisis logika'] },
  { day:'Sabtu', tasks:['Integritas & Pelayanan publik','Manajemen konflik','45 soal + jawaban ideal'] },
  { day:'Minggu', tasks:['Full Tryout','Hitung skor & catat 5 kelemahan','Rencana fokus minggu depan'] }
];
const STORAGE_KEY = 'weekly_bumn_full_v2';

/* helpers */
function el(tag, attrs={}, ...children){
  const e = document.createElement(tag);
  for(const k in attrs){ if(k==='class') e.className = attrs[k]; else e.setAttribute(k, attrs[k]); }
  children.forEach(c=>{ if(!c) return; if(typeof c === 'string') e.appendChild(document.createTextNode(c)); else e.appendChild(c); });
  return e;
}

/* Initialize or migrate state */
function initializeState(){
  let raw = localStorage.getItem(STORAGE_KEY);
  if(raw){
    try{ const s = JSON.parse(raw); if(s && s.template) return s; } catch(e){}
  }
  const tpl = TEMPLATE.map(d => ({ day: d.day, tasks: d.tasks.map(t => ({ title: t, checked:false, files: [] })) }));
  const init = { template: tpl, target:'', reflection:{good:'',bad:'',plan:''}, stats:{streak:0, lastActive:null} };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(init));
  return init;
}
function loadState(){ return JSON.parse(localStorage.getItem(STORAGE_KEY)); }
function saveState(s){ localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); }

/* ---------- UI Builder ---------- */
const daysContainer = document.getElementById('daysContainer');
function buildUI(){
  const s = initializeState(); // ensures existence
  daysContainer.innerHTML = '';
  s.template.forEach((dayObj, di) => {
    const dayWrap = el('div', {class:'day fade-in'});
    const icon = el('div', {class:'icon'}, dayObj.day.charAt(0));
    const body = el('div', {}, el('div',{class:'day-title'}, dayObj.day));

    // progress
    const progressWrap = el('div', {class:'progress-wrap'});
    const progress = el('div', {class:'progress'}, el('i', {}, ''));
    const ptext = el('div', {class:'progress-text'}, '0% selesai');
    progressWrap.appendChild(progress); progressWrap.appendChild(ptext);

    // tasks
    const taskList = el('div', {class:'task-list'});
    dayObj.tasks.forEach((taskObj, ti) => {
      const t = el('div', {class:'task', draggable:'true', id:`task_${di}_${ti}`});
      // drag handlers
      t.addEventListener('dragstart', (ev)=>{ ev.dataTransfer.setData('text/plain', JSON.stringify({di,ti})); t.style.opacity=0.5; });
      t.addEventListener('dragend', ()=>{ t.style.opacity=1 });

      const cb = el('input', {type:'checkbox', id:`cb_${di}_${ti}`});
      cb.checked = !!taskObj.checked;
      cb.addEventListener('change', ()=>{
        const st = loadState(); st.template[di].tasks[ti].checked = cb.checked; saveState(st);
        updateProgress(di);
        markActiveToday();
        renderSmallStats();
      });

      const titleCol = el('div', {}, el('div',{class:'title'}, taskObj.title), el('div',{class:'meta'}, `${(taskObj.files||[]).length} file`));
      titleCol.querySelector('.title').addEventListener('dblclick', ()=>{
        const nt = prompt('Edit tugas', taskObj.title);
        if(nt!==null){ const st=loadState(); st.template[di].tasks[ti].title = nt; saveState(st); buildUI(); }
      });

      t.appendChild(cb); t.appendChild(titleCol);
      taskList.appendChild(t);
    });

    // dragover & drop for reordering within day
    taskList.addEventListener('dragover', (ev)=>{ ev.preventDefault(); });
    taskList.addEventListener('drop', (ev)=>{
      ev.preventDefault();
      try{
        const data = JSON.parse(ev.dataTransfer.getData('text/plain'));
        const fromDi = data.di, fromTi = data.ti;
        // target index
        const target = ev.target.closest('.task');
        let toIndex = Array.from(taskList.children).indexOf(target);
        if(toIndex === -1) toIndex = taskList.children.length;
        const st = loadState();
        const item = st.template[fromDi].tasks.splice(fromTi,1)[0];
        st.template[di].tasks.splice(toIndex,0,item);
        saveState(st); buildUI();
      }catch(e){}
    });

    // pdf zone
    const pdfZone = el('div',{class:'pdf-zone'});
    const pdfActions = el('div',{class:'pdf-actions'});
    const fileInput = el('input',{type:'file',accept:'application/pdf',multiple:true, id:`fi_${di}`});
    fileInput.style.display='none';
    fileInput.addEventListener('change',(e)=>{
      const files = Array.from(e.target.files);
      files.forEach(f=>{
        const reader = new FileReader();
        reader.onload = ()=>{ const st = loadState(); // by default attach to first task
          st.template[di].tasks[0].files = st.template[di].tasks[0].files || [];
          st.template[di].tasks[0].files.push({name:f.name,dataURL:reader.result});
          saveState(st); buildUI(); markActiveToday();
        };
        reader.readAsDataURL(f);
      });
      e.target.value='';
    });
    const uploadAllBtn = el('button',{class:'pdf-btn'}, 'üìÅ Upload ke Hari');
    uploadAllBtn.addEventListener('click', ()=> fileInput.click());
    const uploadSpecificBtn = el('button',{class:'pdf-btn ghost'}, '‚ûï Upload ke Tugastertentu');
    uploadSpecificBtn.addEventListener('click', async ()=>{
      const dayIdx = prompt('Nomor hari (1=Senin..7=Minggu)'); const taskIdx = prompt('Nomor tugas (mulai 1)');
      const diSel = parseInt(dayIdx||'')-1, tiSel = parseInt(taskIdx||'')-1;
      if(isNaN(diSel)||isNaN(tiSel)||!loadState().template[diSel]||!loadState().template[diSel].tasks[tiSel]){ alert('Pilihan tidak valid'); return; }
      const fp = document.createElement('input'); fp.type='file'; fp.accept='application/pdf'; fp.multiple=true;
      fp.onchange = (ev)=>{
        Array.from(ev.target.files).forEach(f=>{
          const r = new FileReader(); r.onload = ()=> {
            const st = loadState(); st.template[diSel].tasks[tiSel].files = st.template[diSel].tasks[tiSel].files||[]; st.template[diSel].tasks[tiSel].files.push({name:f.name, dataURL:r.result}); saveState(st); buildUI();
          }; r.readAsDataURL(f);
        });
      }; fp.click();
    });

    const viewAllBtn = el('button',{class:'pdf-btn ghost'}, 'üìÇ Lihat Semua');
    viewAllBtn.addEventListener('click', ()=> {
      const st = loadState();
      // open first available file
      for(let ti=0; ti<st.template[di].tasks.length; ti++){
        const arr = st.template[di].tasks[ti].files || [];
        if(arr.length){ openDataURL(arr[0].dataURL, `${st.template[di].tasks[ti].title} ‚Äî ${arr[0].name}`); return; }
      }
      alert('Belum ada file di hari ini.');
    });

    pdfActions.appendChild(uploadAllBtn); pdfActions.appendChild(uploadSpecificBtn); pdfActions.appendChild(viewAllBtn);
    pdfZone.appendChild(pdfActions);

    // pdf list per task
    const pdfList = el('div',{class:'pdf-list'});
    dayObj.tasks.forEach((taskObj, ti) => {
      (taskObj.files||[]).forEach((f,fi)=>{
        const item = el('div',{class:'pdf-item'});
        const left = el('div', {}, el('div',{class:'name'}, `${taskObj.title} ‚Äî ${f.name}`), el('small',{}, `Task ${ti+1}`));
        const right = el('div', {}, );
        const view = el('button',{class:'pdf-btn ghost'}, 'Buka');
        view.addEventListener('click', ()=> openDataURL(f.dataURL, `${taskObj.title} ‚Äî ${f.name}`));
        const dl = el('button',{class:'pdf-btn'}, 'Download');
        dl.addEventListener('click', ()=> downloadDataURL(f.dataURL, f.name));
        const del = el('button',{class:'remove-btn'}, '‚úï');
        del.addEventListener('click', ()=> { if(confirm('Hapus file?')){ removeFile(di,ti,fi); buildUI(); } });
        right.appendChild(view); right.appendChild(dl); right.appendChild(del);
        item.appendChild(left); item.appendChild(right); pdfList.appendChild(item);
      });
    });

    body.appendChild(taskList); body.appendChild(progressWrap); body.appendChild(pdfZone); body.appendChild(pdfList);
    dayWrap.appendChild(icon); dayWrap.appendChild(body); daysContainer.appendChild(dayWrap);

    // update progress visuals
    updateProgress(di);
  });
  renderSmallStats();
}

/* ---------- State helpers for files, checked etc ---------- */
function loadStateSafe(){ const s = localStorage.getItem(STORAGE_KEY); return s ? JSON.parse(s) : initializeState(); }
function updateProgress(di){
  const s = loadStateSafe();
  const day = s.template[di];
  const total = day.tasks.length;
  const done = day.tasks.filter(t=>t.checked).length;
  const pct = total ? Math.round(done/total*100) : 0;
  const dayWrap = daysContainer.children[di];
  if(!dayWrap) return;
  const progressBar = dayWrap.querySelector('.progress > i');
  const progressText = dayWrap.querySelector('.progress-text');
  if(progressBar) progressBar.style.width = pct + '%';
  if(progressText) progressText.textContent = `${pct}% selesai`;
}

function addFileToTask(di, ti, fileObj){
  const s = loadStateSafe();
  s.template[di].tasks[ti].files = s.template[di].tasks[ti].files || [];
  s.template[di].tasks[ti].files.push(fileObj);
  saveState(s);
}
function removeFile(di,ti,fi){
  const s = loadStateSafe();
  if(!s.template[di]||!s.template[di].tasks[ti]||!s.template[di].tasks[ti].files) return;
  s.template[di].tasks[ti].files.splice(fi,1);
  saveState(s);
}
function openDataURL(dataURL, title='PDF Viewer'){
  const modal = document.getElementById('modal'); const iframe = document.getElementById('pdfFrame'); document.getElementById('modalTitle').textContent = title;
  iframe.src = dataURL; modal.classList.add('open'); modal.setAttribute('aria-hidden','false');
}
function downloadDataURL(dataURL, filename){
  const a = document.createElement('a'); a.href = dataURL; a.download = filename || 'file.pdf'; document.body.appendChild(a); a.click(); a.remove();
}

/* ---------- Export / Import / CSV ---------- */
document.getElementById('exportBtn').addEventListener('click', ()=>{
  const s = loadStateSafe();
  const blob = new Blob([JSON.stringify(s,null,2)],{type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'weekly_bumn_state.json'; a.click();
  URL.revokeObjectURL(a.href);
});
document.getElementById('importBtn').addEventListener('click', ()=> document.getElementById('importFile').click());
document.getElementById('importFile').addEventListener('change', (e)=>{
  const f = e.target.files[0]; if(!f) return; const r = new FileReader();
  r.onload = ()=> { try{ const s = JSON.parse(r.result); if(!s.template) { alert('File tidak valid'); return; } saveState(s); buildUI(); alert('Import berhasil.'); } catch(err){ alert('Import gagal'); } };
  r.readAsText(f);
});
document.getElementById('exportCSV').addEventListener('click', ()=>{
  const s = loadStateSafe(); let rows = [['Day','Task','Checked','#Files']];
  s.template.forEach(d => d.tasks.forEach(t => rows.push([d.day, t.title, t.checked ? '1':'0', (t.files||[]).length])));
  const csv = rows.map(r=>r.map(c=>`"${String(c).replace(/\"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv],{type:'text/csv'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='weekly_bumn.csv'; a.click();
  URL.revokeObjectURL(a.href);
});

/* ---------- Modal handlers ---------- */
document.getElementById('modalClose').addEventListener('click', ()=> { document.getElementById('modal').classList.remove('open'); document.getElementById('modal').setAttribute('aria-hidden','true'); document.getElementById('pdfFrame').src=''; });
document.getElementById('summaryClose').addEventListener('click', ()=> { document.getElementById('summaryModal').classList.remove('open'); });

/* ---------- Small Stats (chart, streak) ---------- */
function renderSmallStats(){
  const s = loadStateSafe();
  const totalTasks = s.template.reduce((acc,d)=>acc + d.tasks.length,0);
  const doneTasks = s.template.reduce((acc,d)=>acc + d.tasks.filter(t=>t.checked).length,0);
  const donePct = totalTasks ? Math.round(doneTasks/totalTasks*100) : 0;
  // show small stats
  const smallStats = document.getElementById('smallStats'); smallStats.innerHTML = '';
  smallStats.appendChild(el('div',{class:'chip'}, `${donePct}%`));
  // render chart
  renderChart(s);
  // show streak
  const streak = s.stats?.streak || 0;
  smallStats.appendChild(el('div',{style:'font-size:12px;color:var(--muted);margin-left:6px'}, `üî• Streak ${streak} hari`));
}

/* simple bar chart */
function renderChart(s){
  const canvas = document.getElementById('statChart'); if(!canvas) return;
  const ctx = canvas.getContext('2d'); const w = canvas.width; const h = canvas.height; ctx.clearRect(0,0,w,h);
  const labels = s.template.map(d=>d.day.split(' ')[0]);
  const values = s.template.map(d => Math.round((d.tasks.filter(t=>t.checked).length / d.tasks.length) *100));
  // draw bars
  const pad = 20; const gap = 12; const bw = (w - pad*2 - gap*(values.length-1))/values.length;
  values.forEach((v,i)=> {
    const x = pad + i*(bw+gap); const bh = (v/100)* (h - 40);
    ctx.fillStyle = (document.body.getAttribute('data-theme')==='dark') ? '#ff7fa1' : '#b73d53';
    ctx.fillRect(x, h - bh - 20, bw, bh);
    // label
    ctx.fillStyle = (document.body.getAttribute('data-theme')==='dark') ? '#ffdfe7' : '#4a0028';
    ctx.font = '12px Inter, Arial'; ctx.fillText(labels[i], x, h-2);
  });
}

/* ---------- Pomodoro ---------- */
let pom = { work:25*60, break:5*60, timer:null, mode:'work', remaining:25*60, running:false };
function createPomodoroUI(){
  const holder = document.getElementById('pomodoroControls');
  holder.innerHTML = '';
  const display = el('div', {style:'display:flex;align-items:center;gap:12px'});
  const time = el('div',{class:'display'}, formatTime(pom.remaining));
  const start = el('button',{class:'btn primary'}, 'Start');
  const pause = el('button',{class:'btn ghost'}, 'Pause');
  const reset = el('button',{class:'btn ghost'}, 'Reset');
  start.addEventListener('click', ()=> { if(pom.running) return; pom.running=true; pom.timer=setInterval(()=>{ pom.remaining--; if(pom.remaining<=0){ clearInterval(pom.timer); pom.running=false; notify('Pomodoro selesai'); pom.mode = (pom.mode==='work')?'break':'work'; pom.remaining = pom.mode==='work'?pom.work:pom.break; } time.textContent = formatTime(pom.remaining); },1000);});
  pause.addEventListener('click', ()=>{ if(pom.timer) clearInterval(pom.timer); pom.running=false;});
  reset.addEventListener('click', ()=>{ if(pom.timer) clearInterval(pom.timer); pom.running=false; pom.mode='work'; pom.remaining = pom.work; time.textContent = formatTime(pom.remaining);});
  display.appendChild(time); display.appendChild(start); display.appendChild(pause); display.appendChild(reset);
  holder.appendChild(display);
}
function formatTime(s){ const m=Math.floor(s/60); const sec=s%60; return `${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`; }

/* ---------- Reminder ---------- */
let reminderTimer = null;
document.getElementById('setReminder').addEventListener('click', ()=>{
  const t = document.getElementById('reminderTime').value;
  if(!t){ alert('Pilih jam'); return; }
  if(Notification && Notification.permission !== 'granted'){ Notification.requestPermission().then(per=>{ if(per!=='granted') alert('Izin notifikasi dibutuhkan'); else setupReminder(t); }); } else setupReminder(t);
});
function setupReminder(timeStr){
  if(reminderTimer) clearInterval(reminderTimer);
  const [hh,mm] = timeStr.split(':').map(n=>parseInt(n,10));
  reminderTimer = setInterval(()=>{
    const now = new Date(); if(now.getHours()===hh && now.getMinutes()===mm){ notify('Waktunya belajar! ‚ú®'); }
  }, 60*1000);
  alert('Reminder dikonfigurasi setiap hari pada ' + timeStr);
}
function notify(msg){ if(Notification && Notification.permission==='granted') new Notification(msg); else alert(msg); }

/* ---------- AI Summary (simple offline) ---------- */
document.getElementById('openSummary').addEventListener('click', ()=> document.getElementById('summaryModal').classList.add('open'));
document.getElementById('genSummary').addEventListener('click', ()=>{
  const input = document.getElementById('summaryInput').value.trim();
  if(input){
    const sum = simpleSummarize(input);
    document.getElementById('summaryResult').textContent = sum;
  } else {
    // generate from filenames & task titles
    const s = loadStateSafe();
    let lines = [];
    s.template.forEach(d => { d.tasks.forEach(t => { lines.push(`${d.day} - ${t.title} (${(t.files||[]).length} file)`); }); });
    const summary = `Ringkasan otomatis (dari judul tugas & nama file):\n` + lines.slice(0,20).join('\n');
    document.getElementById('summaryResult').textContent = summary;
  }
});
document.getElementById('copySummary').addEventListener('click', ()=> {
  const txt = document.getElementById('summaryResult').textContent;
  navigator.clipboard?.writeText(txt).then(()=> alert('Copied'));
});
function simpleSummarize(text){
  // naive: take top 3 longest sentences
  const sents = text.split(/[.?!]\s+/).map(s=>s.trim()).filter(Boolean);
  sents.sort((a,b)=>b.length-a.length);
  return sents.slice(0,3).join('. ') + (sents.length?'.':'');
}

/* ---------- Utilities ---------- */
function markActiveToday(){
  const s = loadStateSafe();
  const today = new Date().toISOString().slice(0,10);
  if(s.stats && s.stats.lastActive === today) return;
  // if lastActive is yesterday increment streak else reset
  const last = s.stats.lastActive;
  const yesterday = new Date(Date.now() - 24*60*60*1000).toISOString().slice(0,10);
  if(last === yesterday) s.stats.streak = (s.stats.streak||0)+1; else s.stats.streak = 1;
  s.stats.lastActive = today; saveState(s);
  renderSmallStats();
}

/* ---------- Reset & Clear ---------- */
document.getElementById('clearChecks').addEventListener('click', ()=> {
  if(!confirm('Kosongkan semua checklist?')) return;
  const s = loadStateSafe(); s.template.forEach(d=>d.tasks.forEach(t=>t.checked=false)); saveState(s); buildUI();
});
document.getElementById('resetAll').addEventListener('click', ()=> {
  if(!confirm('Reset seluruh data (termasuk file yang tersimpan)?')) return;
  localStorage.removeItem(STORAGE_KEY); initializeState(); buildUI();
});

/* ---------- focus mode & theme & hamburger ---------- */
document.getElementById('focusModeBtn').addEventListener('click', ()=> {
  document.body.classList.toggle('focus-mode');
});
const themeBtn = document.getElementById('themeToggle');
themeBtn.addEventListener('click', ()=> {
  const cur = document.body.getAttribute('data-theme') || 'light';
  const next = cur === 'light' ? 'dark' : 'light';
  document.body.setAttribute('data-theme', next);
  themeBtn.textContent = next === 'dark' ? '‚òÄÔ∏è Light' : 'üåô Dark';
  renderSmallStats();
});
document.getElementById('hamburger').addEventListener('click', ()=> document.getElementById('sidebar').classList.toggle('open'));

/* ---------- modal open helper ---------- */
function openModalWithDataURL(dataURL, title){
  openDataURL(dataURL, title);
}

/* ---------- helpers for manipulating files state when opening from pdfZone upload (above) ---------- */
/* When uploadAllBtn used, we added files to first task of day in fileInput onchange handler */

/* ---------- drag & drop implemented above ---------- */

/* ---------- init ---------- */
initializeState(); buildUI(); createPomodoroUI(); renderSmallStats();

/* keyboard shortcuts for convenience */
document.addEventListener('keydown', (e)=>{ if(e.key==='d') themeBtn.click(); if(e.key==='f') document.getElementById('focusModeBtn').click(); });
</script>
</body>
</html>
